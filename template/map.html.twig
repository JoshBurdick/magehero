<!DOCTYPE html>
<html>
<head>
  {% block head %}
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
	  media="all"/>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/js/leaflet/leaflet.css"/>

    <link type="text/css" rel="stylesheet" href="/js/leaflet/plugins/leaflet.markercluster/MarkerCluster.css"/>
    <link type="text/css" rel="stylesheet"
	  href="/js/leaflet/plugins/leaflet.markercluster/MarkerCluster.Default.css"/>
    <link type="text/css" rel="stylesheet" href="/skin/css/appMap.css"/>
    <title>MageHero | Magento Heroes</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  {% endblock %}
</head>
<body>
<nav class="navbar navbar-inverse navbar-static-top map-nav" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
	      aria-expanded="false" aria-controls="navbar">
	<span class="sr-only">Toggle navigation</span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">MageHero Map</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
	<li class="active"><a href="#">Home</a></li>
	<li><a href="#about">About</a></li>
	<li>
	  <a href="#" onclick="$('#contactModal').modal('show'); return false;">
	    <i class="icon-envelope icon-white"></i> Contact Me</a>
	</li>
	<li>
	  <a href="https://github.com/kalenjordan/magehero" target="_blank"><i
		class="icon-download icon-white"></i> GitHub Repo</a>
	</li>
      </ul>
    </div>
    <!--/.nav-collapse -->
  </div>
</nav>

<div class="modal hide fade" id="contactModal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">Ã—</a>

    <h3>Contact Me!</h3>
  </div>
  <div class="modal-body">
    <p><strong>Email:</strong> email</p>

    <p><strong>Twitter:</strong> username</p>

  </div>
</div>


<div id="map"></div>

<div id="loading-mask" class="modal-backdrop" style="display:none;"></div>
<div id="loading" style="display:none;">
  <div class="loading-indicator">
    <img src="/skin/img/ajax-loader.gif">
  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/leaflet/leaflet-src.js"></script>
<script type="text/javascript" src="/js/leaflet/plugins/leaflet.markercluster/leaflet.markercluster.js"></script>

<script type="text/javascript">
  var map, newUser, users, mapquest, firstLoad;

  firstLoad = true;

  //users = new L.FeatureGroup();
  users = new L.MarkerClusterGroup({spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true});
  newUser = new L.LayerGroup();

  mapquest = new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png", {
    maxZoom: 18,
    subdomains: ["otile1", "otile2", "otile3", "otile4"],
    attribution: 'Basemap tiles courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">. Map data (c) <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors, CC-BY-SA.'
  });

  map = new L.Map('map', {
    center: new L.LatLng(39.90973623453719, -93.69140625),
    zoom: 3,
    layers: [mapquest, users, newUser]
  });

  // GeoLocation Control
  function geoLocate() {
    map.locate({setView: true, maxZoom: 17});
  }
  var geolocControl = new L.control({
    position: 'topright'
  });
  geolocControl.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-control');
    div.innerHTML = '<a class="leaflet-control-geoloc" href="#" onclick="geoLocate(); return false;" title="My location"></a>';
    return div;
  };

  map.addControl(geolocControl);
  map.addControl(new L.Control.Scale());

  //map.locate({setView: true, maxZoom: 3});

  $(document).ready(function () {
    $.ajaxSetup({cache: false});
    $('#map').css('height', ($(window).height() - 40));
    getUsers();
  });

  $(window).resize(function () {
    $('#map').css('height', ($(window).height() - 40));
  }).resize();

  function geoLocate() {
    map.locate({setView: true, maxZoom: 17});
  }

  function getUsers() {
    $.getJSON("/map/users", function (data) {

      for (var i = 0; i < data.length; i++) {
	var location = new L.LatLng(data[i].lat || 0, data[i].lng || 0);
	var name = data[i].name || '';
	var website = data[i].website || '';
	var city = data[i].city || '';
	var title = "<div style='font-size: 18px; color: #0078A8;'>" + name + "</div>";
	if (website.length > 7) {
	  title = "<div style='font-size: 18px; color: #0078A8;'><a href='" + website + "' target='_blank'>" + name + "</a></div>";
	}

	if (city.length > 0) {
	  city = "<div style='font-size: 14px;'>" + city + "</div>";
	}

	var marker = new L.Marker(location, {
	  title: name
	});
	marker.bindPopup("<div style='text-align: center; margin-left: auto; margin-right: auto;'>" + title + city + "</div>", {maxWidth: '400'});
	users.addLayer(marker);
      }
    }).complete(function () {
      if (firstLoad == true) {
	map.fitBounds(users.getBounds());
	firstLoad = false;
      }
      ;
    });
  }


</script>

{% if local_config.getGoogleAnalyticsUa() %}
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
	(i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
	  m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', '{{ local_config.getGoogleAnalyticsUa() }}', 'auto');
    ga('send', 'pageview');
  </script>
{% endif %}
</body>
</html>